<!DOCTYPE html>
<html>
<head>
    <title>Live Face Recognition</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #videoContainer { position: relative; }
        #video { width: 100%; border: 1px solid #ccc; }
        #canvas { position: absolute; top: 0; left: 0; }
        .btn { background: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Live Face Recognition</h1>
    
    <div id="videoContainer">
        <video id="video" autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <div id="results"></div>
    
    <div style="margin-top: 20px;">
        <a href="/" class="btn">Back to Home</a>
        <button id="startBtn" class="btn">Start Recognition</button>
        <button id="stopBtn" class="btn">Stop Recognition</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resultsDiv = document.getElementById('results');
        let recognitionInterval;
        
        // Set canvas size to match video
        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        
        // Start webcam
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    resizeCanvas();
                    video.play();
                };
            } catch (err) {
                console.error("Error accessing webcam:", err);
                resultsDiv.innerHTML = `<p style="color: red;">Error accessing webcam: ${err.message}</p>`;
            }
        }
        
        // Capture frame and send for recognition
        async function captureAndRecognize() {
            if (video.videoWidth === 0) return;
            
            resizeCanvas();
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'frame.jpg');
                
                try {
                    const response = await fetch('/api/recognize', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    // Draw results on canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    data.results.forEach(result => {
                        const [x, y, w, h] = result.box;
                        ctx.strokeStyle = '#0F0';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, w, h);
                        
                        ctx.fillStyle = '#0F0';
                        ctx.font = '16px Arial';
                        ctx.fillText(`${result.name} (${result.confidence.toFixed(2)}%)`, x, y - 10);
                    });
                    
                } catch (error) {
                    console.error("Recognition error:", error);
                }
            }, 'image/jpeg');
        }
        
        // Start/stop buttons
        document.getElementById('startBtn').addEventListener('click', () => {
            startWebcam();
            recognitionInterval = setInterval(captureAndRecognize, 1000); // Process every second
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            clearInterval(recognitionInterval);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
        
        // Initialize
        startWebcam();
    </script>
</body>
</html>